AWSTemplateFormatVersion: 2010-09-09
Description:  Template for deploying IAM policy that requires MFA

Resources:

  requireMfaGroup:
    Type: "AWS::IAM::Group"
    Properties:
      GroupName: "requireMFA"


  mfaPolicy:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      ManagedPolicyName: "A_NAME"
      Description: "Forces users to have an MFA set before they can do anything.  Allows them to set their own MFA device"
      Path: "/"
      Groups:
        - !Ref requireMfaGroup
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - "Sid": "AllowUsersToManageTheirOwnPasswordsAndKeys"
            "Effect": Allow
            "Resource": !Sub "arn:aws:iam::${AWS::AccountId}:user/${aws:username}"
            "Action":
              - "iam:*LoginProfile"
              - "iam:*AccessKey"
              - "iam:*SSHPublicKey*"
          - "Sid": "AllowUsersToListAccountInformation"
            "Effect": Allow
            "Resource": "*"
            "Action":
              - "iam:ListAccount*"
              - "iam:GetAccountSummary"
              - "iam:GetAccountPasswordPolicy"
              - "iam:ListUsers"
          - "Sid": "AllowUsersToCreateEnableResyncDeleteTheirOwnVirtualMFADevice"
            "Effect": Allow
            "Resource":
              - !Sub "arn:aws:iam::${AWS::AccountId}:mfa/${aws:username}"
              - !Sub "arn:aws:iam::${AWS::AccountId}:user/${aws:username}"
            "Action":
              - "iam:CreateVirtualMFADevice"
              - "iam:EnableMFADevice"
              - "iam:ResyncMFADevice"
              - "iam:DeleteVirtualMFADevice"
          - "Sid": "AllowUsersToDeactivateTheirOwnVirtualMFADevice"
            "Effect": Allow
            "Resource":
              - !Sub "arn:aws:iam::${AWS::AccountId}:mfa/${aws:username}"
              - !Sub "arn:aws:iam::${AWS::AccountId}:user/${aws:username}"
            "Action":
              - "iam:DeactivateMFADevice"
            "Condition":
                Bool:
                  "aws:MultiFactorAuthPresent": true

